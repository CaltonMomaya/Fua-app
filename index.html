<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fua Application - Register</title>
  <link rel="stylesheet" href="style.css" />
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

  <style>
    .password-criteria {
      font-size: 12px;
      color: #666;
      margin: 5px 0;
      padding: 0 10px;
    }
    .criteria-met { color: green; }
    .criteria-not-met { color: red; }

    .phone-input-container {
      display: flex;
      align-items: center;
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 5px;
    }
    .flag-symbol {
      width: 20px;
      height: 15px;
      background: linear-gradient(to bottom, black 0%, black 33.33%, red 33.33%, red 66.66%, green 66.66%, green 100%);
      border: 1px solid #ccc;
      margin-right: 5px;
      position: relative;
    }
    .flag-symbol::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 33.33%;
      height: 100%;
      background:
        linear-gradient(135deg, transparent 45%, white 45%, white 55%, transparent 55%),
        linear-gradient(225deg, transparent 45%, white 45%, white 55%, transparent 55%),
        linear-gradient(to bottom, black 0%, black 33.33%, red 33.33%, red 66.66%, green 66.66%, green 100%);
    }
    .phone-prefix {
      display: flex;
      align-items: center;
      font-weight: bold;
      color: #333;
      padding-right: 10px;
      border-right: 1px solid #ccc;
      margin-right: 5px;
    }
    .phone-input {
      flex: 1;
      border: none;
      outline: none;
      padding: 0 10px;
    }
    .input-box {
      position: relative;
      margin-bottom: 15px;
    }
    .input-box i {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #777;
    }
    .password-toggle {
      cursor: pointer;
      font-size: 18px;
    }
    .password-toggle:hover { color: #333; }
  </style>
</head>
<body>
  <div class="container">
    <div class="left-side"></div>
    <div class="wrapper">
      <form id="registerForm">
        <h1>Welcome to Fua Konnect</h1>

        <!-- Username -->
        <div class="input-box">
          <input type="text" id="username" placeholder="Input Username" required>
          <i class='bx bx-user'></i>
        </div>

        <!-- Password -->
        <div class="input-box">
          <input type="password" id="password" placeholder="Input Password" required>
          <i class='bx bx-show password-toggle' id="passwordToggle"></i>
        </div>

        <div class="password-criteria">
          <span id="length" class="criteria-not-met">• At least 8 characters</span><br>
          <span id="capital" class="criteria-not-met">• One capital letter</span><br>
          <span id="symbol" class="criteria-not-met">• One symbol</span>
        </div>

        <!-- Confirm Password -->
        <div class="input-box">
          <input type="password" id="confirmPassword" placeholder="Confirm Password" required>
          <i class='bx bx-show password-toggle' id="confirmPasswordToggle"></i>
        </div>

        <!-- Phone -->
        <div class="input-box">
          <div class="phone-input-container">
            <div class="phone-prefix">
              <div class="flag-symbol"></div>
              <span>+254</span>
            </div>
            <input type="tel" id="phone" class="phone-input" placeholder="7XXXXXXXX" required pattern="[0-9]{9}" maxlength="9">
          </div>
        </div>

        <!-- User Type -->
        <div class="input-box">
          <select class="register-select" id="userType" required>
            <option value="" disabled selected>Register as</option>
            <option value="mama-fua">Mama Fua</option>
            <option value="client">Client</option>
          </select>
          <i class='bx bx-user-plus'></i>
        </div>

        <!-- Gender -->
        <div class="input-box gender-box">
          <label><input type="radio" name="gender" value="male" required> Male</label>
          <label><input type="radio" name="gender" value="female" required> Female</label>
        </div>

        <!-- Email -->
        <div class="input-box">
          <input type="email" id="email" placeholder="Input Email Address"
                 pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$" required>
          <i class='bx bx-envelope-open'></i>
        </div>

        <!-- DOB -->
        <div class="input-box">
          <label>Select Date of Birth:</label>
          <input type="date" id="dob" required>
          <i class='bx bx-calendar-alt'></i>
        </div>

        <div class="remember-forgot">
          <label><input type="checkbox" id="rememberMe"> Remember me</label>
          <a href="mainlog.html">Already have an account? Login</a>
        </div>

        <button type="submit" class="button">Register</button>
      </form>
    </div>
  </div>

  <!-- ✅ EmailJS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    (function() {
      emailjs.init("KqZoTEnAMf0vBJ2dM"); // Replace with your EmailJS Public Key
    })();
  </script>

  <!-- ✅ Firebase + OTP Verification -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDV9rLWwVfJ92teYPkXWFALYEqmZO2E4Yk",
      authDomain: "fua-app-a2fb5.firebaseapp.com",
      projectId: "fua-app-a2fb5",
      storageBucket: "fua-app-a2fb5.appspot.com",
      messagingSenderId: "1093221394623",
      appId: "1:1093221394623:web:3d8c8afe038cdacd53be0a",
      measurementId: "G-LCW00REGF8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ✅ Password toggle logic
    const togglePassword = (fieldId, toggleId) => {
      const field = document.getElementById(fieldId);
      const icon = document.getElementById(toggleId);
      icon.onclick = () => {
        if (field.type === "password") {
          field.type = "text";
          icon.classList.replace("bx-show", "bx-hide");
        } else {
          field.type = "password";
          icon.classList.replace("bx-hide", "bx-show");
        }
      };
    };
    togglePassword("password", "passwordToggle");
    togglePassword("confirmPassword", "confirmPasswordToggle");

    // ✅ Password validation
    const passwordInput = document.getElementById("password");
    const lengthCriteria = document.getElementById("length");
    const capitalCriteria = document.getElementById("capital");
    const symbolCriteria = document.getElementById("symbol");

    function validatePassword(password) {
      const hasMinLength = password.length >= 8;
      const hasCapital = /[A-Z]/.test(password);
      const hasSymbol = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password);
      lengthCriteria.className = hasMinLength ? 'criteria-met' : 'criteria-not-met';
      capitalCriteria.className = hasCapital ? 'criteria-met' : 'criteria-not-met';
      symbolCriteria.className = hasSymbol ? 'criteria-met' : 'criteria-not-met';
      return hasMinLength && hasCapital && hasSymbol;
    }
    passwordInput.addEventListener("input", e => validatePassword(e.target.value));

    // ✅ OTP Generator
    function generateOTP() {
      return Math.floor(100000 + Math.random() * 900000).toString();
    }

    // ✅ Submit with OTP verification
    document.getElementById("registerForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value;
      const confirmPassword = document.getElementById("confirmPassword").value;
      const phone = "+254" + document.getElementById("phone").value.trim();
      const userType = document.getElementById("userType").value;
      const email = document.getElementById("email").value.trim();
      const dob = document.getElementById("dob").value;
      const gender = document.querySelector('input[name="gender"]:checked')?.value;

      if (!validatePassword(password)) return alert("Password criteria not met.");
      if (password !== confirmPassword) return alert("Passwords do not match.");

      const otp = generateOTP();

      try {
        await emailjs.send("service_lhfe8dg", "template_1h3z4ix", {
          to_email: email,
          user_name: username,
          otp_code: otp
        });

        const userOTP = prompt("An OTP has been sent to your email. Enter it to continue:");
        if (userOTP === otp) {
          await addDoc(collection(db, "users"), {
            username, phone, email, dob, gender, userType, password,
            createdAt: new Date().toISOString()
          });
          alert("✅ Registration successful! You can now login.");
          window.location.href = "mainlog.html";
        } else {
          alert("❌ Incorrect OTP. Please try again.");
        }
      } catch (error) {
        console.error("Error sending OTP or saving:", error);
        alert("An error occurred. Please try again.");
      }
    });
  </script>
</body>
</html>
