<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fua Application - Register</title>
  <link rel="stylesheet" href="style.css" />
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

  <style>
    .password-criteria {
      font-size: 12px;
      color: #666;
      margin: 5px 0;
      padding: 0 10px;
    }
    .criteria-met { color: green; }
    .criteria-not-met { color: red; }

    .phone-input-container {
      display: flex;
      align-items: center;
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 5px;
    }
    .flag-symbol {
      width: 20px;
      height: 15px;
      background: linear-gradient(to bottom, black 0%, black 33.33%, red 33.33%, red 66.66%, green 66.66%, green 100%);
      border: 1px solid #ccc;
      margin-right: 5px;
      position: relative;
    }
    .flag-symbol::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 33.33%;
      height: 100%;
      background:
        linear-gradient(135deg, transparent 45%, white 45%, white 55%, transparent 55%),
        linear-gradient(225deg, transparent 45%, white 45%, white 55%, transparent 55%),
        linear-gradient(to bottom, black 0%, black 33.33%, red 33.33%, red 66.66%, green 66.66%, green 100%);
    }
    .phone-prefix {
      display: flex;
      align-items: center;
      font-weight: bold;
      color: #333;
      padding-right: 10px;
      border-right: 1px solid #ccc;
      margin-right: 5px;
    }
    .phone-input {
      flex: 1;
      border: none;
      outline: none;
      padding: 0 10px;
    }
    .input-box {
      position: relative;
      margin-bottom: 15px;
    }
    .input-box i {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #777;
    }
    .password-toggle {
      cursor: pointer;
      font-size: 18px;
    }
    .password-toggle:hover { color: #333; }

    /* ✅ Modern OTP Modal */
    .otp-modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .otp-modal.active { display: flex; }

    .otp-box {
      background: white;
      border-radius: 15px;
      padding: 25px 30px;
      text-align: center;
      width: 90%;
      max-width: 350px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
      animation: popIn 0.3s ease;
    }
    @keyframes popIn {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    .otp-box h2 {
      margin-bottom: 10px;
      color: #333;
    }
    .otp-box p {
      font-size: 14px;
      color: #666;
      margin-bottom: 15px;
    }
    .otp-input {
      font-size: 20px;
      padding: 10px;
      width: 80%;
      text-align: center;
      border: 2px solid #ccc;
      border-radius: 8px;
      outline: none;
      margin-bottom: 10px;
    }
    .otp-input:focus {
      border-color: #00bfa5;
    }
    .otp-button {
      padding: 10px 20px;
      background-color: #00bfa5;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 10px;
    }
    .otp-button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .countdown {
      font-size: 14px;
      color: #ff0000;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="left-side"></div>
    <div class="wrapper">
      <form id="registerForm">
        <h1>Welcome to Fua Konnect</h1>

        <div class="input-box">
          <input type="text" id="username" placeholder="Input Username" required>
          <i class='bx bx-user'></i>
        </div>

        <div class="input-box">
          <input type="password" id="password" placeholder="Input Password" required>
          <i class='bx bx-show password-toggle' id="passwordToggle"></i>
        </div>

        <div class="password-criteria">
          <span id="length" class="criteria-not-met">• At least 8 characters</span><br>
          <span id="capital" class="criteria-not-met">• One capital letter</span><br>
          <span id="symbol" class="criteria-not-met">• One symbol</span>
        </div>

        <div class="input-box">
          <input type="password" id="confirmPassword" placeholder="Confirm Password" required>
          <i class='bx bx-show password-toggle' id="confirmPasswordToggle"></i>
        </div>

        <div class="input-box">
          <div class="phone-input-container">
            <div class="phone-prefix">
              <div class="flag-symbol"></div>
              <span>+254</span>
            </div>
            <input type="tel" id="phone" class="phone-input" placeholder="7XXXXXXXX" required pattern="[0-9]{9}" maxlength="9">
          </div>
        </div>

        <div class="input-box">
          <select class="register-select" id="userType" required>
            <option value="" disabled selected>Register as</option>
            <option value="mama-fua">Mama Fua</option>
            <option value="client">Client</option>
          </select>
          <i class='bx bx-user-plus'></i>
        </div>

        <div class="input-box gender-box">
          <label><input type="radio" name="gender" value="male" required> Male</label>
          <label><input type="radio" name="gender" value="female" required> Female</label>
        </div>

        <div class="input-box">
          <input type="email" id="email" placeholder="Input Email Address"
                 pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$" required>
          <i class='bx bx-envelope-open'></i>
        </div>

        <div class="input-box">
          <label>Select Date of Birth:</label>
          <input type="date" id="dob" required>
          <i class='bx bx-calendar-alt'></i>
        </div>

        <div class="remember-forgot">
          <label><input type="checkbox" id="rememberMe"> Remember me</label>
          <a href="mainlog.html">Already have an account? Login</a>
        </div>

        <button type="submit" class="button">Register</button>
      </form>
    </div>
  </div>

  <!-- ✅ Modern OTP Modal -->
  <div class="otp-modal" id="otpModal">
    <div class="otp-box">
      <h2>Email Verification</h2>
      <p>Enter the 6-digit OTP sent to your email.</p>
      <input type="text" id="otpInput" class="otp-input" maxlength="6" placeholder="Enter OTP">
      <div class="countdown" id="countdown">01:00</div>
      <button id="verifyOtpBtn" class="otp-button">Verify OTP</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    (function() { emailjs.init("MGI62By2LOWVwfjYc"); })();
    document.getElementById("dob").max = new Date().toISOString().split("T")[0];
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDV9rLWwVfJ92teYPkXWFALYEqmZO2E4Yk",
      authDomain: "fua-app-a2fb5.firebaseapp.com",
      projectId: "fua-app-a2fb5",
      storageBucket: "fua-app-a2fb5.appspot.com",
      messagingSenderId: "1093221394623",
      appId: "1:1093221394623:web:3d8c8afe038cdacd53be0a",
      measurementId: "G-LCW00REGF8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const togglePassword = (id, toggleId) => {
      const field = document.getElementById(id);
      const icon = document.getElementById(toggleId);
      icon.onclick = () => {
        field.type = field.type === "password" ? "text" : "password";
        icon.classList.toggle("bx-show");
        icon.classList.toggle("bx-hide");
      };
    };
    togglePassword("password", "passwordToggle");
    togglePassword("confirmPassword", "confirmPasswordToggle");

    const passwordInput = document.getElementById("password");
    const lengthC = document.getElementById("length");
    const capitalC = document.getElementById("capital");
    const symbolC = document.getElementById("symbol");
    const validatePassword = p => {
      const okLen = p.length >= 8;
      const okCap = /[A-Z]/.test(p);
      const okSym = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(p);
      lengthC.style.color = okLen ? "green" : "red";
      capitalC.style.color = okCap ? "green" : "red";
      symbolC.style.color = okSym ? "green" : "red";
      return okLen && okCap && okSym;
    };
    passwordInput.addEventListener("input", e => validatePassword(e.target.value));

    const generateOTP = () => Math.floor(100000 + Math.random() * 900000).toString();

    document.getElementById("registerForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value;
      const confirmPassword = document.getElementById("confirmPassword").value;
      const phone = "+254" + document.getElementById("phone").value.trim();
      const userType = document.getElementById("userType").value;
      const email = document.getElementById("email").value.trim();
      const dob = document.getElementById("dob").value;
      const gender = document.querySelector('input[name="gender"]:checked')?.value;

      if (!validatePassword(password)) return alert("Password criteria not met.");
      if (password !== confirmPassword) return alert("Passwords do not match.");

      const otp = generateOTP();
      const validUntil = new Date(Date.now() + 60 * 1000);

      try {
        await emailjs.send("service_lhfe8dg", "template_1h3z4ix", {
          to_email: email,
          to_name: username,
          otp_code: otp,
          valid_until: validUntil.toLocaleTimeString()
        });

        // ✅ Show modal
        const modal = document.getElementById("otpModal");
        modal.classList.add("active");
        const countdown = document.getElementById("countdown");
        const verifyBtn = document.getElementById("verifyOtpBtn");
        const otpInput = document.getElementById("otpInput");
        let remaining = 60;
        const timer = setInterval(() => {
          remaining--;
          const m = String(Math.floor(remaining / 60)).padStart(2, '0');
          const s = String(remaining % 60).padStart(2, '0');
          countdown.textContent = `${m}:${s}`;
          if (remaining <= 0) {
            clearInterval(timer);
            verifyBtn.disabled = true;
            countdown.textContent = "OTP expired!";
          }
        }, 1000);

        verifyBtn.onclick = async () => {
          if (otpInput.value === otp && remaining > 0) {
            clearInterval(timer);
            modal.classList.remove("active");
            await addDoc(collection(db, "users"), {
              username, phone, email, dob, gender, userType, password,
              createdAt: new Date().toISOString()
            });
            alert("✅ Registration successful! You can now login.");
            window.location.href = "mainlog.html";
          } else {
            alert("❌ Incorrect or expired OTP.");
          }
        };
      } catch (error) {
        console.error("Error sending OTP or saving:", error);
        alert("An error occurred. Please try again.");
      }
    });
  </script>
</body>
</html>
